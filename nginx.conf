# # events {
# #     worker_connections 1024;
# # }

# # http {
# #     include mime.types;
# #     default_type application/octet-stream;
# #     sendfile on;
# #     keepalive_timeout 65;

# #     server {
# #         listen 80;
# #         server_name _;

# #         add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
# #         add_header X-Content-Type-Options "nosniff" always;
# #         add_header Referrer-Policy "no-referrer" always;
# #         add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
# #         server_tokens off;
        
# #         root /var/www/html/public;

# #         index index.php;

# #         location / {
# #             try_files $uri /index.php$is_args$args;
# #         }

# #         location ~ \.php$ {
# #             include fastcgi_params;
# #             fastcgi_pass 127.0.0.1:9000;
# #             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
# #             fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
# #             fastcgi_param HTTP_X_FORWARDED_HOST $http_x_forwarded_host;
# #             fastcgi_param HTTP_X_FORWARDED_PORT $server_port;
# #             fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
# #             fastcgi_buffer_size 32k;
# #             fastcgi_buffers 4 32k;
# #         }

# #         location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|ttf|svg|mp4)$ {
# #             expires 1M;
# #             access_log off;
# #             add_header Cache-Control "public";
# #         }
# #     }
# # }

# # nginx.conf pour le backend
# events {
#     worker_connections 1024;
# }

# http {
#     include mime.types;
#     default_type application/octet-stream;
#     sendfile on;
#     keepalive_timeout 65;
    
#     server {
#         listen 80;
#         server_name _;

#         root /var/www/html/public;

#         # Ajout des en-têtes de sécurité pour l'API
#         add_header X-Content-Type-Options nosniff always;
#         add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
#         add_header X-XSS-Protection "1; mode=block" always;
#         # La CSP est plus simple car le backend n'a pas à charger des scripts/styles externes
#         add_header Content-Security-Policy "default-src 'self'; style-src 'self'; font-src 'self'; img-src 'self'; frame-ancestors 'none'; form-action 'self';" always;
#         add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
#         add_header Referrer-Policy "no-referrer" always;
#         add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

#         server_tokens off;
        
#         # Ce bloc gère toutes les requêtes qui ne sont pas des fichiers statiques et les envoie à Symfony
#         location / {
#             try_files $uri /index.php$is_args$args;
#         }

#         # Ce bloc gère les requêtes PHP via FastCGI
#         location ~ \.php$ {
#             include fastcgi_params;
#             fastcgi_pass 127.0.0.1:9000;
#             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#             # Ajoutez ces paramètres pour que Symfony reçoive les infos du proxy Railway
#             fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
#             fastcgi_param HTTP_X_FORWARDED_HOST $http_x_forwarded_host;
#             fastcgi_param HTTP_X_FORWARDED_PORT $server_port;
#             fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
#         }

#         # Blocs pour les fichiers statiques de l'API (e.g. les images uploadées)
#         location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|ttf|svg|mp4)$ {
#             expires 1M;
#             access_log off;
#             add_header Cache-Control "public";
#         }
#     }
# }

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    
    server {
        listen 80;
        server_name _;
        
        # Ajout des en-têtes de sécurité pour l'API
        add_header X-Content-Type-Options nosniff always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Content-Security-Policy "default-src 'self'; style-src 'self'; font-src 'self'; img-src 'self'; frame-ancestors 'none'; form-action 'self';" always;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

        server_tokens off;
        
        root /var/www/html/public;

        # Gère les requêtes PHP via FastCGI
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            # Ces paramètres sont essentiels pour que Symfony sache que la requête vient du proxy
            fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
            fastcgi_param HTTP_X_FORWARDED_HOST $http_x_forwarded_host;
            fastcgi_param HTTP_X_FORWARDED_PORT $server_port;
            fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        }

        # Blocs pour les fichiers statiques de l'API (e.g. les images uploadées)
        location /media/ {
            alias /var/www/html/public/media/;
            access_log off;
            expires 30d;
        }

        # Gère les autres requêtes de l'API
        location / {
            try_files $uri /index.php$is_args$args;
        }
    }
}